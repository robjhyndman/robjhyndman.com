{
  "hash": "89e149bb0af092f3ff40b7cbb618e4ae",
  "result": {
    "markdown": "---\ndate: 2015-10-28 02:43:47+00:00\nlink: https://robjhyndman.com/hyndsight/piecewise-linear-trends/\nslug: piecewise-linear-trends\ntitle: Piecewise linear trends\ncategories:\n- forecasting\n- R\n- time series\n- trend\n---\n\n\nI prepared the following notes for a consulting client, and I thought they might be of interest to some other people too.\n\nLet $y_t$ denote the value of the time series at time $t$, and suppose we wish to fit a trend with correlated errors of the form\n$$ y_t = f(t) + n_t, $$\nwhere $f(t)$ represents the possibly nonlinear trend and $n_t$ is an autocorrelated error process.\n\nFor example, if $f(t) = \\beta_0+\\beta_1 t$ is a linear function, then we can simply set $x_{1,t}=t$ and define\n$$ y_t = \\beta_0 + \\beta_1x_{1,t} + n_t. $$\nIn matrix form we can write\n$$ \\boldsymbol{y} = \\beta_0 + \\boldsymbol{X}\\boldsymbol{\\beta} + \\boldsymbol{n},$$\nwhere $\\boldsymbol{y}=[y_1,\\dots,y_T]'$, $\\boldsymbol{n}=[n_1,\\dots,n_T]'$, $\\boldsymbol{\\beta}=[\\beta_1]$ and $\\boldsymbol{X} = [x_{1,1},\\dots,x_{1,T}]'$. Note that I have left the intercept $\\beta_0$ out of the vector $\\boldsymbol{\\beta}$ so that the $\\boldsymbol{X}$ matrix matches the required `xreg` argument in `auto.arima`.\n\nThis model can be estimated by setting the `xreg` argument to be a matrix with one column:\n$$\n\\boldsymbol{X} = \\left[\\begin{array}{c}\n1\\\\\n2\\\\\n3\\\\\n4\\\\\n\\vdots\\\\\nT\n\\end{array}\\right]\n$$\n\n```r\nx1 <- 1:length(y)\nfit <- auto.arima(y, xreg=x1)\n```\n\nThe associated coefficient is the slope of the trend line.\n\nHere is a simple example of a linear trend fitted to the Asian sheep data from the `fpp` package :\n\n\n::: {.cell hash='index_cache/html/unnamed-chunk-1_589ab22300b7b2a7b31d908c21f7070f'}\n\n```{.r .cell-code}\nlibrary(fpp)\nT <- length(livestock)\nx1 <- seq(T)\nfit <- auto.arima(livestock, xreg=x1)\nfc <- forecast(fit, xreg=T+seq(10))\nb0 <- coef(fit)[\"intercept\"]\nb1 <- coef(fit)[\"x1\"]\nt <- seq(T+10)\ntrend <- ts(b0 + b1*t, start=start(livestock))\n\nplot(fc, main=\"Linear trend with AR(1) errors\")\nlines(trend, col='red')\n```\n\n::: {.cell-output-display}\n![*A linear trend fitted to the Asian sheep data. The automatically selected error term is an AR(1) process.*](index_files/figure-html/unnamed-chunk-1-1.png){width=672}\n:::\n:::\n\n\nA more flexible approach is to use a piecewise linear trend which bends at some time. If the trend bends at time $\\tau$, then it can be specified by including the following predictors in the model.\n\\begin{align}\n x_{1,t}  &=  t \\\\\n x_{2,t} &=  \\begin{cases}\n0 & t < \\tau;\\\\\n(t-\\tau) &  t \\ge \\tau.\n\\end{cases}\n\\end{align}\nIn `auto.arima`, set `xreg` to be a matrix with two columns:\n$$\n\\boldsymbol{X} = \\left[\\begin{array}{ll}\n1 & 0\\\\\n2 & 0\\\\\n3 & 0\\\\\n4 & 0\\\\\n\\vdots\\\\\n\\tau & 0 \\\\\n\\tau+1 & 1\\\\\n\\tau+2 & 2\\\\\n\\vdots \\\\\nT & T-\\tau\n\\end{array}\\right]\n$$\n\n\n```r\nfit <- auto.arima(y, xreg=cbind(x1, pmax(0,x1-tau))\n```\n\nIf the associated coefficients of $x_{1,t}$ and $x_{2,t}$ are $\\beta_1$ and $\\beta_2$, then $\\beta_1$ gives the slope of the trend before time $\\tau$, while the slope of the line after time $\\tau$ is given by $\\beta_1+\\beta_2$.\n\nThis can be extended to allow any number of \"bend points\" known as knots. Just add additional columns with 0s before each knot, and values 1, 2, ... after the knot.\n\nHere is a piecewise linear trend fitted to the Asian sheep data with knots at years 1990 and 1992:\n\n\n::: {.cell hash='index_cache/html/unnamed-chunk-2_cad90ad59d81d7f41045c27d9e0aee7e'}\n\n```{.r .cell-code}\nx2 <- pmax(0, x1-30)\nx3 <- pmax(0, x1-32)\nfit <- auto.arima(livestock, xreg=cbind(x1,x2,x3))\nfc <- forecast(fit,\n       xreg=cbind(max(x1)+seq(10), max(x2)+seq(10), max(x3)+seq(10)))\nb0 <- coef(fit)[\"intercept\"]\nb1 <- coef(fit)[\"x1\"]\nb2 <- coef(fit)[\"x2\"]\nb3 <- coef(fit)[\"x3\"]\ntrend <- ts(b0 + b1*t + b2*pmax(0,t-30) + b3*pmax(0,t-32),\n       start=start(livestock))\n\nplot(fc, main=\"Piecewise linear trend with AR(1) errors\")\nlines(trend, col='red')\n```\n\n::: {.cell-output-display}\n![*A piecewise-linear trend fitted to the Asian sheep data.*](index_files/figure-html/unnamed-chunk-2-1.png){width=672}\n:::\n:::\n\n\nIf there is to be no trend before the first knot, but a piecewise linear trend thereafter,  leave out the first column of the above matrix $\\boldsymbol{X}$.\n\nIf there is to be a piecewise linear trend up to the last knot, but no trend thereafter, a slightly modified set up can be used. For one knot at time $\\tau$, we can set\n$$\n\\boldsymbol{X} = \\left[\\begin{array}{r}\n1-\\tau \\\\\n2-\\tau \\\\\n\\vdots\\\\\n-2\\\\\n-1\\\\\n0 \\\\\n0 \\\\\n\\vdots \\\\\n0\n\\end{array}\\right]\n$$\n\n```r\nxreg <- pmin(0, x1-tau)\n```\n\nwhere the first 0 in the column is in row $\\tau$. Additional knots can be handled in the same way. For example, if there are two knots, then   $\\beta_1+\\beta_2$ will be the slope of the trend up to the first knot, and $\\beta_2$ will be the  slope between the first and second knots.\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}